name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., 0.4.0)'
        required: true
        type: string

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout homebrew-mcpx
        uses: actions/checkout@v5
        with:
          repository: AIGC-Hackers/homebrew-mcpx
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download release assets
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p downloads
          cd downloads

          echo "Downloading binaries for v$VERSION..."
          curl -sL "https://github.com/AIGC-Hackers/mcpx/releases/download/v$VERSION/mcpx-darwin-arm64" -o mcpx-darwin-arm64
          curl -sL "https://github.com/AIGC-Hackers/mcpx/releases/download/v$VERSION/mcpx-linux-arm64" -o mcpx-linux-arm64
          curl -sL "https://github.com/AIGC-Hackers/mcpx/releases/download/v$VERSION/mcpx-linux-x64" -o mcpx-linux-x64

          echo "Downloading shell completions..."
          curl -sL "https://raw.githubusercontent.com/AIGC-Hackers/mcpx/v$VERSION/completions/_mcpx" -o _mcpx
          curl -sL "https://raw.githubusercontent.com/AIGC-Hackers/mcpx/v$VERSION/completions/mcpx.bash" -o mcpx.bash
          curl -sL "https://raw.githubusercontent.com/AIGC-Hackers/mcpx/v$VERSION/completions/mcpx.fish" -o mcpx.fish

          ls -lh

      - name: Calculate checksums
        id: checksums
        run: |
          cd downloads
          echo "darwin_arm64=$(shasum -a 256 mcpx-darwin-arm64 | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "linux_arm64=$(shasum -a 256 mcpx-linux-arm64 | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "linux_x64=$(shasum -a 256 mcpx-linux-x64 | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "zsh_completion=$(shasum -a 256 _mcpx | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "bash_completion=$(shasum -a 256 mcpx.bash | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "fish_completion=$(shasum -a 256 mcpx.fish | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Update formula
        run: |
          VERSION=${{ steps.version.outputs.version }}

          cat > Formula/mcpx.rb << EOF
          # ⚠️  AUTO-GENERATED - DO NOT EDIT MANUALLY!
          # This file is generated by CI. Manual edits will be overwritten.
          # To update: See CLAUDE.md or trigger update-homebrew.yml workflow
          class Mcpx < Formula
            desc "Extended TypeScript runtime and CLI for Model Context Protocol"
            homepage "https://github.com/AIGC-Hackers/mcpx"
            version "$VERSION"
            license "MIT"

            on_macos do
              url "https://github.com/AIGC-Hackers/mcpx/releases/download/v$VERSION/mcpx-darwin-arm64"
              sha256 "${{ steps.checksums.outputs.darwin_arm64 }}"
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/AIGC-Hackers/mcpx/releases/download/v$VERSION/mcpx-linux-arm64"
                sha256 "${{ steps.checksums.outputs.linux_arm64 }}"
              else
                url "https://github.com/AIGC-Hackers/mcpx/releases/download/v$VERSION/mcpx-linux-x64"
                sha256 "${{ steps.checksums.outputs.linux_x64 }}"
              end
            end

            resource "zsh-completion" do
              url "https://raw.githubusercontent.com/AIGC-Hackers/mcpx/v$VERSION/completions/_mcpx"
              sha256 "${{ steps.checksums.outputs.zsh_completion }}"
            end

            resource "bash-completion" do
              url "https://raw.githubusercontent.com/AIGC-Hackers/mcpx/v$VERSION/completions/mcpx.bash"
              sha256 "${{ steps.checksums.outputs.bash_completion }}"
            end

            resource "fish-completion" do
              url "https://raw.githubusercontent.com/AIGC-Hackers/mcpx/v$VERSION/completions/mcpx.fish"
              sha256 "${{ steps.checksums.outputs.fish_completion }}"
            end

            def install
              bin.install Dir["mcpx-*"].first => "mcpx"

              # Install shell completions
              resource("zsh-completion").stage { zsh_completion.install "_mcpx" }
              resource("bash-completion").stage { bash_completion.install "mcpx.bash" => "mcpx" }
              resource("fish-completion").stage { fish_completion.install "mcpx.fish" }
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/mcpx --version")
            end
          end
          EOF

          echo "Formula updated:"
          cat Formula/mcpx.rb

      - name: Commit and push
        run: |
          VERSION=${{ steps.version.outputs.version }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/mcpx.rb
          git commit -m "chore: update to v$VERSION"
          git push
